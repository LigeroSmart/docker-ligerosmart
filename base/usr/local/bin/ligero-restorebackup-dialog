#!/bin/bash

set +x

SCREEN_TITLE="Restore backup"
BACKUP_LIST=`find /app-backups/* -type d -printf "%T@ %f\n" | sort -nr | awk '{ print $2 }'` # sort by date

# backup permissions
chown -R otrs /app-backups 
chmod -R 750 /app-backups

echo $choiceArr
BACKUP_DIR=$(dialog --backtitle "$SCREEN_TITLE" --title "Backup selection" --no-items --menu "Select one backup directory to restore" 15 60 4 $BACKUP_LIST 3>&1 1>&2 2>&3)

clear

[ ! -f "/app-backups/$BACKUP_DIR/DatabaseBackup.sql.gz" ] && echo "DatabaseBackup.sql.gz not found or access forbidden inside $BACKUP_DIR" && exit 1

if [ -f "/app-backups/$BACKUP_DIR/Application.tar.gz" ]; then
    cd /tmp
    tar -xzf /app-backups/$BACKUP_DIR/Application.tar.gz ./RELEASE
    eval `egrep '(PRODUCT|VERSION)' /tmp/RELEASE | sed 's/ = /=/g'`
    PRODUCT_VERSION_LABEL="($PRODUCT $VERSION)"
    CHOOSE_RESTORE_TYPE=1
fi;

if [ $CHOOSE_RESTORE_TYPE == 1 ]; then
    RESTORE_TYPE=$(dialog --backtitle "$SCREEN_TITLE" --title "Restore type" --menu "How do you want to restore backup from $BACKUP_DIR?" 15 60 4 \
            1 "Upgrade to LigeroSmart $RELEASE_TAG" \
            2 "Restore backup as is $PRODUCT_VERSION_LABEL" \
    3>&1 1>&2 2>&3)

    [ -z "$RESTORE_TYPE" ] && exit 1
else 
    RESTORE_TYPE=1
fi;

dialog --title "WARNING! Clean database?" \
--backtitle "$SCREEN_TITLE" \
--yesno "Are you sure you want to clean database \"$APP_Database\" and restore backup from directory \"$BACKUP_DIR\"?" 7 60

clear

# Detect paths
MYSQL=$(which mysql)
AWK=$(which awk)
GREP=$(which grep)

# clean database
TABLES=$($MYSQL -h $APP_DatabaseHost -u $APP_DatabaseUser -p$APP_DatabasePw $APP_Database -e 'show tables' | $AWK '{ print $1}' | $GREP -v '^Tables' )
 
for t in $TABLES
do
    echo "Deleting $t table from $APP_Database database..."
    $MYSQL -h $APP_DatabaseHost -u $APP_DatabaseUser -p$APP_DatabasePw $APP_Database -e "SET FOREIGN_KEY_CHECKS=0; drop table $t" 2> /dev/null 1> /dev/null
done


TMP_RESTORE_DIR=/tmp/app-restore

[ -d "$TMP_RESTORE_DIR" ] && rm -rf $TMP_RESTORE_DIR

mkdir $TMP_RESTORE_DIR

chown otrs:www-data $TMP_RESTORE_DIR

ln -sf /app-backups/$BACKUP_DIR/DatabaseBackup.sql.gz $TMP_RESTORE_DIR/DatabaseBackup.sql.gz

if [ "$RESTORE_TYPE" -eq 1 ]; then
    export RESTORE_DIR=$TMP_RESTORE_DIR
    su otrs -c /app-init.sh
    exit 0
fi;

if [ "$RESTORE_TYPE" -eq 2 ]; then
    ln -sf /app-backups/$BACKUP_DIR/Config.tar.gz $TMP_RESTORE_DIR/Config.tar.gz
    ln -sf /app-backups/$BACKUP_DIR/Application.tar.gz $TMP_RESTORE_DIR/Application.tar.gz
    su otrs -c "/opt/otrs/scripts/restore.pl -b $TMP_RESTORE_DIR -d /opt/otrs"
    exit 0
fi;

otrs.SetPermissions.pl --web-group=www-data
